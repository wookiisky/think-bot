# 分叉功能

## 原始需求
大模型回复后，增加一个分支(branch)功能，可以基于当前对话，调用其他模型生成回答。


1 在大模型回复消息右侧悬浮按钮中：
    - 预览按钮置顶；分支（branch）按钮位于第二个
    - 置顶/置底滚动按钮位于中间
    - “复制文本 / 复制 Markdown”两个按钮移动到最底部
    - 删除当前分支按钮仍与分支操作同组，位于复制按钮之前
2 可以点击分支按钮，会在点击消息右侧分出新的一列，触发新的大模型调用
    - 持久化状态，和之前逻辑一致，增加branch_id来定位
3 分支消息展示：
    - 分支消息和初始回复消息并排分列展示，每个消息右方都有独立的悬浮按钮
    - 消息悬浮按钮下方展示小文本，指出使用的模型
    - 分支消息调用大模型时时，复用调用大模型的loading状态（转圈loading和中断并删除这个分支按钮），尽量复用tab loading状态，重新加载等逻辑
    
4 导出时，增加待模型名的列分割线，依次输出

注意：
1 继续聊天时，如果回复时有多个候选，默认取第一列放入消息历史
2 对话数据结构更改，每一轮回复消息变成数组，更新存储，导出，同步等
3 conversations页面复用了sidebar的对话逻辑，注意复用和保持一致
4 对话数据的向后兼容
5 branch的生命周期管理和状态交互，尽量复用已有逻辑
6 注意markdown展示

## 功能概述

实现对话界面的分叉功能，允许用户针对同一个用户消息使用不同模型生成多个回复分支，并支持分支管理、导出和同步等完整功能。

## 核心需求

1. 在assistant消息右侧悬浮按钮中将分支(branch)按钮调整为第二个位置（预览在首位）
2. 点击后显示所有模型下拉列表，选择模型后调用生成新分支
3. 之前的回复消息右侧分出新列，展示新模型的回复状态和结果
4. 回复完成后，可以继续点击分叉按钮分出更多列
5. 悬浮按钮增加删除按钮，删除所在分支的回复
6. 导出时增加模型名称标识和列分割线
7. 继续聊天时默认使用第一分支作为消息历史

## 交互调整（行为变更）

- 分支创建时取消自动滚动：当在已有回复上点击分支并触发新的回复时，不再自动跳转到消息中部，保持当前滚动位置。如需定位，请使用消息悬浮按钮中的“置顶/置底”滚动按钮。
- 已完成分支消息预览按钮：在分支消息的浮动按钮组最上方新增“预览”按钮，点击后在页面中央弹出预览层展示该分支的完整内容；点击弹层外部区域或按 ESC 可关闭预览。
  - 历史加载的分支同样补齐该按钮，行为与新生成分支一致。
  - conversations 页面也启用该预览弹层与按钮，样式和交互与侧边栏一致。
  - 预览弹层内容容器使用与消息相同的 `.message-content`，从而复用 `sidebar/styles/markdown.css` 的 Markdown 样式，保证展示一致。
  - 预览弹层高度提升（内容区 `max-height` 约 85vh），更适合查看长内容。
  - 标题去除图标，仅居中显示模型名，减小标题区高度，并将标题区与内容区背景做区分（标题区沿用白底，内容区采用与消息一致的浅灰色）。
  - 预览弹层宽度减少约四分之一（max-width 从 800px 到 600px，百分比宽度从 92% 到 69%）。
  - 打开弹层时，内容滚动条自动滚动到最顶部。

## 分支上下文规则

- 分支调用时，不发送当前轮的助手消息（即被分叉的那条回复）。
- 分支请求的上下文最后一条必须是上一轮的用户消息，避免模型将当前助手回复误作为对话结尾。
- 后台对携带 `branchId` 的请求会自动进行上述裁剪，侧边栏在构造分支上下文时也会排除当前助手消息以保持一致。

